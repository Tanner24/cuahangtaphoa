generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// I. SAAS LEVEL TABLES
// ==========================================

model SubscriptionPlan {
  id           Int      @id @default(autoincrement())
  name         String   @unique
  maxProducts  Int      @default(50) @map("max_products")
  maxUsers     Int      @default(1) @map("max_users")
  price        Decimal  @default(0)
  durationDays Int      @default(30) @map("duration_days")
  features     String?  // SQLite: stored as JSON string
  createdAt    DateTime @default(now()) @map("created_at")

  stores             Store[]
  storeSubscriptions StoreSubscription[]

  @@map("subscription_plans")
}

model Store {
  id                    Int       @id @default(autoincrement())
  name                  String
  ownerName             String?   @map("owner_name")
  phone                 String?   @unique
  email                 String?   @unique
  address               String?
  status                String    @default("active") // active, suspended, expired
  subscriptionPlanId    Int?      @map("subscription_plan_id")
  subscriptionExpiredAt DateTime? @map("subscription_expired_at")
  bankName              String?   @map("bank_name")
  bankAccountName       String?   @map("bank_account_name")
  bankAccountNumber     String?   @map("bank_account_number")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  subscriptionPlan   SubscriptionPlan?   @relation(fields: [subscriptionPlanId], references: [id])
  storeSubscriptions StoreSubscription[]
  payments           Payment[]
  users              User[]
  products           Product[]
  invoices           Invoice[]
  customers          Customer[]
  systemLogs         SystemLog[]
  categories         Category[]
  brands             Brand[]
  returnRequests     ReturnRequest[]
  expenses           Expense[]
  taxPayments        TaxPayment[]
  salaryPayments     SalaryPayment[]
  accountingPeriods  AccountingPeriod[]
  importReceipts     ImportReceipt[]
  appLogs            AppLog[]
  supportTickets     SupportTicket[]

  @@map("stores")
}

model StoreSubscription {
  id        Int      @id @default(autoincrement())
  storeId   Int      @map("store_id")
  planId    Int      @map("plan_id")
  startDate DateTime @default(now()) @map("start_date")
  endDate   DateTime @map("end_date")
  status    String   @default("active") // active, expired, canceled
  paymentId Int?     @map("payment_id")
  createdAt DateTime @default(now()) @map("created_at")

  store Store            @relation(fields: [storeId], references: [id], onDelete: Cascade)
  plan  SubscriptionPlan @relation(fields: [planId], references: [id])

  @@map("store_subscriptions")
}

model Payment {
  id             Int       @id @default(autoincrement())
  storeId        Int       @map("store_id")
  amount         Decimal
  method         String?
  status         String    @default("pending") // pending, completed, failed
  transactionRef String?   @map("transaction_ref")
  paidAt         DateTime? @map("paid_at")
  createdAt      DateTime  @default(now()) @map("created_at")

  store Store @relation(fields: [storeId], references: [id])

  @@map("payments")
}

// ==========================================
// II. POS LEVEL TABLES (Multi-tenant)
// ==========================================

model User {
  id           Int       @id @default(autoincrement())
  storeId      Int       @map("store_id")
  username     String
  passwordHash String    @map("password_hash")
  fullName     String?   @map("full_name")
  role         String    @default("staff") // super_admin, support_admin, billing_admin, owner, manager, staff
  isActive     Boolean   @default(true) @map("is_active")
  lastLogin    DateTime? @map("last_login")
  createdAt    DateTime  @default(now()) @map("created_at")

  store      Store       @relation(fields: [storeId], references: [id], onDelete: Cascade)
  invoices       Invoice[]
  systemLogs     SystemLog[]
  salaryPayments SalaryPayment[]
  lockedPeriods  AccountingPeriod[]
  appLogs        AppLog[]

  @@unique([storeId, username])
  @@map("users")
}

model Category {
  id          Int      @id @default(autoincrement())
  storeId     Int      @map("store_id")
  name        String
  description String?
  createdAt   DateTime @default(now()) @map("created_at")

  store    Store     @relation(fields: [storeId], references: [id], onDelete: Cascade)
  products Product[]

  @@unique([storeId, name])
  @@map("categories")
}

model Brand {
  id          Int      @id @default(autoincrement())
  storeId     Int      @map("store_id")
  name        String
  description String?
  createdAt   DateTime @default(now()) @map("created_at")

  store    Store     @relation(fields: [storeId], references: [id], onDelete: Cascade)
  products Product[]

  @@unique([storeId, name])
  @@map("brands")
}

model Product {
  id           Int      @id @default(autoincrement())
  storeId      Int      @map("store_id")
  name         String
  barcode      String?
  category     String? // Deprecated in favor of categoryId
  categoryId   Int?     @map("category_id")
  brandId      Int?     @map("brand_id")
  price        Decimal  @default(0)
  priceIn      Decimal? @default(0) @map("price_in")
  currentStock Int      @default(0) @map("current_stock")
  minStockThreshold Int @default(5)  @map("min_stock_threshold")
  unit         String   @default("cái")
  imageUrl     String?  @map("image_url")
  createdAt    DateTime @default(now()) @map("created_at")

  store       Store     @relation(fields: [storeId], references: [id], onDelete: Cascade)
  categoryRel Category? @relation(fields: [categoryId], references: [id])
  brand       Brand?    @relation(fields: [brandId], references: [id])
  
  invoiceItems InvoiceItem[]
  returnItems  ReturnItem[]
  importItems  ImportItem[]

  @@map("products")
}

model Invoice {
  id            Int      @id @default(autoincrement())
  storeId       Int      @map("store_id")
  code          String   @unique
  customerId    Int?     @map("customer_id")
  userId        Int?     @map("user_id")
  totalAmount   Decimal  @map("total_amount")
  paymentMethod String?  @map("payment_method")
  note          String?
  createdAt     DateTime @default(now()) @map("created_at")

  store    Store         @relation(fields: [storeId], references: [id], onDelete: Cascade)
  user     User?         @relation(fields: [userId], references: [id])
  customer Customer?     @relation(fields: [customerId], references: [id])
  items    InvoiceItem[]
  returnRequests ReturnRequest[]

  @@map("invoices")
}

model InvoiceItem {
  id        Int     @id @default(autoincrement())
  invoiceId Int     @map("invoice_id")
  productId Int     @map("product_id")
  quantity  Int
  price     Decimal

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@map("invoice_items")
}

model ReturnRequest {
  id          Int      @id @default(autoincrement())
  storeId     Int      @map("store_id")
  invoiceId   Int      @map("invoice_id")
  returnCode  String   @unique @map("return_code")
  totalAmount Decimal  @map("total_amount")
  reason      String?
  status      String   @default("completed") // pending, completed
  createdAt   DateTime @default(now()) @map("created_at")
  createdBy   Int?     @map("created_by")

  store       Store       @relation(fields: [storeId], references: [id], onDelete: Cascade)
  invoice     Invoice     @relation(fields: [invoiceId], references: [id])
  items       ReturnItem[]

  @@map("return_requests")
}

model ReturnItem {
  id              Int      @id @default(autoincrement())
  returnRequestId Int      @map("return_request_id")
  productId       Int      @map("product_id")
  quantity        Int
  refundPrice     Decimal  @map("refund_price")

  returnRequest   ReturnRequest @relation(fields: [returnRequestId], references: [id], onDelete: Cascade)
  product         Product       @relation(fields: [productId], references: [id])

  @@map("return_items")
}

model Customer {
  id          Int      @id @default(autoincrement())
  storeId     Int      @map("store_id")
  name        String
  phone       String?
  address     String?
  debtBalance Decimal  @default(0) @map("debt_balance")
  createdAt   DateTime @default(now()) @map("created_at")

  store    Store     @relation(fields: [storeId], references: [id], onDelete: Cascade)
  invoices Invoice[]

  @@map("customers")
}

// ==========================================
// III. SYSTEM LOGS & AUDIT
// ==========================================

model SystemLog {
  id         Int      @id @default(autoincrement())
  userId     Int?     @map("user_id")
  storeId    Int?     @map("store_id")
  action     String
  entityType String?  @map("entity_type")
  entityId   String?  @map("entity_id")
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent")
  oldData    String?  @map("old_data") // SQLite: JSON as String
  newData    String?  @map("new_data") // SQLite: JSON as String
  createdAt  DateTime @default(now()) @map("created_at")

  user  User?  @relation(fields: [userId], references: [id])
  store Store? @relation(fields: [storeId], references: [id])

  @@map("system_logs")
}

// ==========================================
// V. INVENTORY MANAGEMENT (S2 Helper)
// ==========================================

model ImportReceipt {
  id          Int      @id @default(autoincrement())
  storeId     Int      @map("store_id")
  code        String   @unique // Mã phiếu nhập (NK001...)
  supplier    String?  // Nhà cung cấp
  importDate  DateTime @default(now()) @map("import_date")
  totalAmount Decimal  @map("total_amount")
  note        String?
  createdAt   DateTime @default(now()) @map("created_at")
  
  store       Store        @relation(fields: [storeId], references: [id], onDelete: Cascade)
  items       ImportItem[]

  @@map("import_receipts")
}

model ImportItem {
  id              Int      @id @default(autoincrement())
  importReceiptId Int      @map("import_receipt_id")
  productId       Int      @map("product_id")
  quantity        Int
  importPrice     Decimal  @map("import_price")
  
  importReceipt ImportReceipt @relation(fields: [importReceiptId], references: [id], onDelete: Cascade)
  product       Product       @relation(fields: [productId], references: [id])

  @@map("import_items")
}

// ==========================================
// IV. ACCOUNTING & REPORTING (TT88/2021)
// ==========================================

model Expense {
  id            Int      @id @default(autoincrement())
  storeId       Int      @map("store_id")
  date          DateTime @default(now())
  amount        Decimal
  category      String   // 'electricity', 'water', 'rent', 'other'
  description   String?
  paymentMethod String   @default("CASH") @map("payment_method") // CASH, TRANSFER
  invoiceCode   String?  @map("invoice_code") // Sổ chi phí cần số chứng từ
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@map("expenses")
}

model TaxPayment {
  id            Int      @id @default(autoincrement())
  storeId       Int      @map("store_id")
  date          DateTime @default(now())
  amount        Decimal
  taxType       String   @map("tax_type") // VAT, PIT, LICENSE
  description   String?
  paymentMethod String   @default("TRANSFER") @map("payment_method")
  receiptCode   String?  @map("receipt_code")
  createdAt     DateTime @default(now()) @map("created_at")

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@map("tax_payments")
}

model SalaryPayment {
  id           Int      @id @default(autoincrement())
  storeId      Int      @map("store_id")
  userId       Int?     @map("user_id") // Optional, can be manual name
  employeeName String?  @map("employee_name")
  month        Int
  year         Int
  baseSalary   Decimal  @map("base_salary")
  bonus        Decimal  @default(0)
  deduction    Decimal  @default(0)
  totalAmount  Decimal  @map("total_amount")
  paymentDate  DateTime @default(now()) @map("payment_date")
  status       String   @default("paid") // pending, paid
  createdAt    DateTime @default(now()) @map("created_at")

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)
  user  User? @relation(fields: [userId], references: [id])

  @@map("salary_payments")
}

model AccountingPeriod {
  id        Int      @id @default(autoincrement())
  storeId   Int      @map("store_id")
  month     Int
  year      Int
  isLocked  Boolean  @default(false) @map("is_locked")
  lockedAt  DateTime? @map("locked_at")
  lockedBy  Int?     @map("locked_by")

  // Snapshots
  openingBalanceCash Decimal @default(0) @map("opening_balance_cash")
  openingBalanceBank Decimal @default(0) @map("opening_balance_bank")
  closingBalanceCash Decimal @default(0) @map("closing_balance_cash")
  closingBalanceBank Decimal @default(0) @map("closing_balance_bank")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)
  locker User? @relation(fields: [lockedBy], references: [id])

  @@unique([storeId, month, year])
  @@map("accounting_periods")
}

model AppLog {
  id        Int      @id @default(autoincrement())
  storeId   Int      @map("store_id")
  userId    Int?     @map("user_id") // Optional, user who performed the action
  action    String   // UPDATE, DELETE, CREATE (optional)
  entity    String   // Invoice, Product, etc.
  entityId  String   @map("entity_id") // ID of the affected record (as string for flexibility)
  oldData   Json?    @map("old_data") // Snapshot BEFORE change
  newData   Json?    @map("new_data") // Snapshot AFTER change
  ipAddress String?  @map("ip_address")
  device    String?
  createdAt DateTime @default(now()) @map("created_at")

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)
  user  User? @relation(fields: [userId], references: [id])

  @@map("app_logs")
}

model Announcement {
  id        Int      @id @default(autoincrement())
  title     String
  content   String
  type      String   @default("info") // info, warning, danger
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("announcements")
}

model SystemSetting {
  id    Int     @id @default(autoincrement())
  key   String  @unique
  value String  // Stores JSON string or plain value
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("system_settings")
}

model SupportTicket {
  id          Int      @id @default(autoincrement())
  storeId     Int      @map("store_id")
  subject     String
  status      String   @default("open") // open, pending, resolved, closed
  priority    String   @default("medium") // low, medium, high
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  store    Store           @relation(fields: [storeId], references: [id], onDelete: Cascade)
  messages TicketMessage[]

  @@map("support_tickets")
}

model TicketMessage {
  id        Int      @id @default(autoincrement())
  ticketId  Int      @map("ticket_id")
  senderId  Int?     @map("sender_id") // ID of AdminUser or POS User
  senderRole String   @map("sender_role") // admin, user, system
  senderName String?  @map("sender_name")
  content   String
  createdAt DateTime @default(now()) @map("created_at")

  ticket SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@map("ticket_messages")
}

